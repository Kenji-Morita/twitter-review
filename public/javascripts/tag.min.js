riot.tag("commonfooter",'<footer class="sg-footer"><div class="sg-container"><p>(c)2015 SAW</p></div></footer>',function(e){}),riot.tag("commonheader",'<header class="sg-header"><div class="sg-container"><ul class="sg-header-contents"><li><h1><a href="/">SAW Twitter</a></h1></li><li if="{opts.isLogin}"><a href="#">Setting</a><ul><li><a href="#">Setting</a></li><li><a href="#" onclick="{doSignOut}">Sign out</a></li></ul></li></ul></div></header>',function(e){var t=this,i=window.superagent;this.member=null,this.isLogin=e.isLogin,this.observable=riot.observable(),this.doSignOut=function(e){e.preventDefault(),i.post("/api/auth/signout").withCredentials().end(function(e,t){t.ok&&(location.href="/")})};var o="member-";this.findMemberDetail=function(e){var n=localStorage.getItem(o+e);n?(t.member=JSON.parse(n),t.observable.trigger("onLoadMember",t.member)):i.get("/api/member/detail/"+e).end(function(i,n){n.ok&&(t.member=JSON.parse(n.text).value,t.observable.trigger("onLoadMember",t.member),localStorage.setItem(o+e,JSON.stringify(t.member)))})},this.loaded=function(){if(e.isLogin){var n="loginMember",s=localStorage.getItem(n);s?(t.loginMember=JSON.parse(s),t.observable.trigger("onLoadLoginMember",t.loginMember)):i.get("/api/auth/member/detail").withCredentials().end(function(e,i){if(i.ok){t.loginMember=JSON.parse(i.text).value,t.observable.trigger("onLoadLoginMember",t.loginMember);var s=JSON.stringify(t.loginMember);localStorage.setItem(n,s),localStorage.setItem(o+t.loginMember.memberId,s)}})}},this.mixin({profile:{loginMember:!0,memberId:null},timeline:{target:"home"}})}),riot.tag("follow",'<div if="{opts.isLogin && !isMe}"><button if="{!isFollowing}" onclick="{doFollow}">Follow</button><button if="{isFollowing}" onclick="{doUnFollow}">Unfollow</button></div>',function(e){var t=this,i=window.superagent;this.isFollowing=!1,this.isMe=!1,void 0!=e.observable&&e.observable.on("onLoadMember",function(i){e.member=i,e.isLogin&&(e.loginMember.following.list.indexOf(i.memberId)>=0&&(t.isFollowing=!0),t.isMe=e.loginMember.memberId==i.memberId,t.update())}),this.doFollow=function(o){o.preventDefault(),i.post("/api/member/follow/"+e.member.memberId).withCredentials().end(function(e,i){i.ok&&(t.isFollowing=!0,t.update())})},this.doUnFollow=function(o){o.preventDefault(),i.del("/api/member/unfollow/"+e.member.memberId).withCredentials().end(function(e,i){i.ok&&(t.isFollowing=!1,t.update())})}}),riot.tag("post",'<form onsubmit="{doPostTweet}" class="sg-post-tweet"><p>tweet length: {tweetLength}</p><textarea oninput="{doInputTweet}"></textarea><button __disabled="{textLengthInvalid}">Tweet</button></form>',function(e){var t=this,i=window.superagent;this.tweetLength=0,this.textLengthInvalid=!0,this.doInputTweet=function(e){var i=e.target;o(i.value),t.update()},this.doPostTweet=function(t){t.preventDefault();var n=t.target.querySelectorAll("textarea")[0];i.post("/api/tweet/tweet").withCredentials().send({text:n.value}).set("Accept","application/json").end(function(t,i){i.ok&&(n.value="",o(n.value),e.observable.trigger("onPost"))})};var o=function(e){t.tweetLength=e.length,t.textLengthInvalid=t.tweetLength>140||t.tweetLength<=0?!0:!1,t.update()}}),riot.tag("profileaside","",function(e){}),riot.tag("profileaside",'<aside class="pg-profile"><img src="/assets/icon/1"><h2>{opts.member.displayName}</h2><p>{opts.member.biography}</p><dl><dt>Followings</dt><dd><a href="/following/{opts.member.memberId}">{opts.member.following.count}</a></dd><dt>Followers</dt><dd><a href="/followers/{opts.member.memberId}">{opts.member.followers.count}</a></dd></dl></aside>',function(e){{var t=this;window.superagent}void 0!=e.observable&&(e.profile.loginMember?e.loaded():e.findMemberDetail(e.profile.memberId),e.observable.on("onLoadMember",function(i){e.member=i,t.update()})),e.profile.loginMember&&e.loginMember&&(e.member=e.loginMember)}),riot.tag("signforms",'<ul><li if="{!toggleState}"><a href="#" onclick="{toggle}">Sign in</a></li><li if="{toggleState}"><a href="#" onclick="{toggle}">Sign up</a></li></ul><form class="pg-sign-in" if="{toggleState}" onsubmit="{doSignIn}"><label if="{signIn.account.isEmpty}">Please input Mail Address or Name!</label><input type="text" name="account" placeholder="Mail address or Name"><label if="{signIn.password.isEmpty}">Please input Password!</label><input type="password" name="signInPassword" placeholder="Password"><button>Sign in</button></form><form class="pg-sign-up" if="{!toggleState}" onsubmit="{doSignUp}"><label if="{signUp.screenName.isEmpty}">Please input Account Name!</label><input type="text" name="screenName" placeholder="Account Name"><label if="{signUp.displayName.isEmpty}">Please input Display Name!</label><input type="text" name="displayName" placeholder="Display Name"><label if="{signUp.mail.isEmpty}">Please input Mail Address!</label><input type="mail" name="mail" placeholder="Mail address"><label if="{signUp.password.isEmpty}">Please input Password!</label><input type="password" name="signUpPassword" placeholder="Password"><label if="{signUp.passwordConfirm.isEmpty}">Please input Password again!</label><input type="password" name="signUpPasswordConfirm" placeholder="Password confirm"><button>Sign up</button></form>',function(e){var t=this,i=window.superagent;this.toggleState=!0,this.signIn={account:{isEmpty:!1},password:{isEmpty:!1}},this.signUp={screenName:{isEmpty:!1},displayName:{isEmpty:!1},mail:{isEmpty:!1},password:{isEmpty:!1},passwordConfirm:{isEmpty:!1}},this.toggle=function(e){e.preventDefault();var i=document.querySelector(".pg-sign");i.classList.toggle("hoge"),t.toggleState=!t.toggleState},this.doSignIn=function(e){e.preventDefault();var o=t.account.value.trim(),n=t.signInPassword.value.trim();t.signIn.account.isEmpty=""==o,t.signIn.password.isEmpty=""==n,t.signIn.account.isEmpty||t.signIn.password.isEmpty||i.post("api/auth/signin").withCredentials().send({account:o,password:n}).set("Accept","application/json").end(function(e,t){if(t.ok)location.reload();else{var i=JSON.parse(t.text);console.log(i.reason)}})},this.doSignUp=function(e){e.preventDefault();var o=t.screenName.value.trim(),n=t.displayName.value.trim(),s=t.mail.value.trim(),a=t.signUpPassword.value.trim(),l=t.signUpPasswordConfirm.value.trim();t.signUp.screenName.isEmpty=""==o,t.signUp.displayName.isEmpty=""==n,t.signUp.mail.isEmpty=""==s,t.signUp.password.isEmpty=""==a,t.signUp.passwordConfirm.isEmpty=""==l,t.signUp.screenName.isEmpty||t.signUp.displayName.isEmpty||t.signUp.mail.isEmpty||t.signUp.password.isEmpty||t.signUp.passwordConfirm.isEmpty||i.post("api/auth/signup").send({screenName:o,displayName:n,mail:s,password:a,passwordConfirm:l}).set("Accept","application/json").end(function(e,t){t.ok&&location.reload()})}}),riot.tag("timeline",'<ul class="pg-timeline"><li class="pg-timeline-tweet" each="{tweets}"><img src="http://placehold.jp/64x64.png"><h3><a href="/member/{memberId}">screenName</a></h3><p data-tweet-id="{tweetId}">{text}</p><time><a href="/tweet/{tweetId}">{postedAt}</a></time></li></ul>',function(e){var t=this,i=window.superagent;this.tweets=[],e.observable.on("onPost",function(){setTimeout(o,1e3)});var o=function(){var o="/api/timeline/"+e.timeline.target;t.tweets.length>0&&(o+="?after="+t.tweets[0].timestamp),i.get(o).withCredentials().end(function(e,i){if(i.ok){var o=JSON.parse(i.text);t.tweets=_.chain(o.value).map(function(e){return{memberId:e.memberId,tweetId:e.tweetId,text:e.text,postedAt:e.postedAt,timestamp:e.timestamp}}).concat(t.tweets).value(),t.update()}})},n=function(){o(),setTimeout(n,1e4)};n()}),riot.tag("tweet",'<section><header><img alt="memberIcon" src="/assets/icon/1"><dl><dt>{opts.member.displayName}</dt><dd>@{opts.member.screenName}</dd></dl><follow></follow></header><p if="{isRetweet}">{opts.tweet.reTweet.text}</p><p>{opts.tweet.text}</p><footer><time>{opts.tweet.postedAt}</time></footer></section>',function(e){var t=this,i=window.superagent;this.isRetweet=!1,e.observable.on("onLoadMember",function(i){e.member=i,t.update()}),i.get("/api/tweet/detail/"+e.tweetId).end(function(i,o){if(o.ok){var n=JSON.parse(o.text);e.tweet=n.value,t.isRetweet=null!=e.tweet.reTweet,t.update(),e.findMemberDetail(e.tweet.memberId)}})});